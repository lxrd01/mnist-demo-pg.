# db/db.py


# Импортируем необходимые модули:
# os - для работы с переменными окружения и операционной системой
import os
# dotenv - для загрузки переменных окружения из файла .env
from dotenv import load_dotenv
# psycopg2 - основной драйвер PostgreSQL для Python
import psycopg2
# SimpleConnectionPool - класс для создания пула соединений с БД
from psycopg2.pool import SimpleConnectionPool

# Загружаем переменные окружения из файла .env
# Файл .env находится в корне проекта и содержит конфиденциальные данные
load_dotenv()

# Получаем строку подключения к базе данных из переменных окружения
# DATABASE_URL содержит: протокол, пользователя, пароль, хост, порт и имя БД
DATABASE_URL = os.getenv("DATABASE_URL")

# Проверяем, что переменная DATABASE_URL установлена
# Если нет - выбрасываем исключение с понятным сообщением
if not DATABASE_URL:
    raise RuntimeError("DATABASE_URL not set")

# Создаем пул соединений с базой данных
# Пул соединений - это коллекция заранее установленных соединений с БД,
# которые переиспользуются, чтобы избежать накладных расходов на установление
# нового соединения для каждого запроса
_pool = SimpleConnectionPool(
    minconn=1,  # минимальное количество соединений, которые будут созданы сразу
    maxconn=5,  # максимальное количество соединений в пуле
    dsn=DATABASE_URL  # Data Source Name - строка подключения к БД
)


# Функция для получения соединения из пула
def get_conn():
    """
    Возвращает соединение с базой данных из пула соединений.

    Если в пуле есть свободное соединение - возвращает его.
    Если нет свободных соединений, но не достигнут maxconn - создает новое.
    Если достигнут maxconn - блокируется до тех пор, пока соединение не освободится.

    Returns:
        psycopg2.connection: Объект соединения с базой данных
    """
    return _pool.getconn()


# Функция для возврата соединения обратно в пул
def put_conn(conn):
    """
    Возвращает соединение обратно в пул для повторного использования.

    Args:
        conn: Объект соединения с базой данных, который нужно вернуть в пул

    Важно: Всегда возвращайте соединения в пул после использования,
    чтобы избежать утечек соединений и исчерпания лимита maxconn.
    """
    if conn:
        # Проверяем, что соединение не None перед возвратом в пул
        _pool.putconn(conn)
