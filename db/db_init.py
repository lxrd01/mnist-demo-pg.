# db/db_init.py

# Импортируем функции для работы с подключением к базе данных
# get_conn - функция для получения подключения к БД
# put_conn - функция для возврата подключения в пул (или закрытия)
from db.db import get_conn, put_conn

# DDL (Data Definition Language) - язык определения данных
# Содержит SQL-команды для создания структуры базы данных
DDL = """
-- Создаем схему 'demo', если она еще не существует
-- Схема - это контейнер для таблиц, функций, представлений в PostgreSQL
CREATE SCHEMA IF NOT EXISTS demo;

-- Создаем таблицу для хранения образцов из датасета MNIST
-- MNIST - это набор данных рукописных цифр (0-9)
CREATE TABLE IF NOT EXISTS demo.mnist_samples (
  -- BIGSERIAL - автоинкрементирующийся BIGINT (большое целое число)
  -- PRIMARY KEY - первичный ключ, уникально идентифицирует каждую запись
  id BIGSERIAL PRIMARY KEY,

  -- Поле для указания к какой части датасета относится образец
  -- 'train' - тренировочная выборка, 'test' - тестовая выборка
  split TEXT NOT NULL,        -- 'train' / 'test'

  -- Метка (label) - цифра от 0 до 9, которую представляет изображение
  label INTEGER NOT NULL,

  -- Векторизованное представление изображения
  -- BYTEA - тип данных для хранения бинарных данных в PostgreSQL
  -- Изображение MNIST: 28x28 пикселей = 784 значения
  -- Каждое значение преобразовано в float32 и сохранено как байты
  vec BYTEA NOT NULL,         -- 784 * float32 .tobytes()

  -- Количество строк в исходном изображении (фиксировано для MNIST = 28)
  rows INTEGER NOT NULL,      -- 28

  -- Количество столбцов в исходном изображении (фиксировано для MNIST = 28)
  cols INTEGER NOT NULL       -- 28
);

-- Создаем индекс для ускорения запросов по полям split и label
-- Индекс ускоряет поиск и фильтрацию по этим колонкам
-- Например: WHERE split = 'train' AND label = 5
CREATE INDEX IF NOT EXISTS idx_mnist_split_label ON demo.mnist_samples(split, label);
"""

# Проверяем, запущен ли этот файл напрямую (а не импортирован как модуль)
if __name__ == "__main__":
    # Получаем подключение к базе данных
    conn = get_conn()

    try:
        # Создаем курсор для выполнения SQL-запросов
        # Курсор - это объект для выполнения операций с БД
        with conn.cursor() as cur:
            # Выполняем DDL-скрипт, который создает схему, таблицу и индекс
            cur.execute(DDL)
            # Фиксируем изменения в базе данных
            # commit() сохраняет все изменения, сделанные в транзакции
            conn.commit()

        # Выводим сообщение об успешном выполнении
        print("✅ demo.mnist_samples готова")

    finally:
        # Блок finally выполняется всегда, даже если возникла ошибка
        # Возвращаем подключение обратно в пул (или закрываем его)
        put_conn(conn)
